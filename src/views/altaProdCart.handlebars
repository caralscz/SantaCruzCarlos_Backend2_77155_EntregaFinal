<!--
// -----------------------------------------------------------
// src/views/altaProdCart.handlebars
// Vista en detalle de un carrito al que se dio de alta un producto. 
// -----------------------------------------------------------
-->
<!-- Linea del título -->
<div class="tit-simple">
    <h1>Coder Shop - Carrito actualizado</h1>
</div>
<hr  class="lineaSupTit" >

      {{!-- Botón Comprar: Crear un ticket de compra  --}}

      <form id="ticketForm" style="display:inline;">
          <button type="button" 
          class="btn-treal" 
          onclick="crearTicket('{{cart._id}}')"
          title="Crear un ticket de compra por este carrito del carrito ">
    Comprar 
  </button>
</form>

<table border="1" cellpadding="6">
  <thead>
    <tr>
      <th>product Id</th>
      <th>Producto</th>
      <th>Código</th>
      <th>Cantidad</th>
      <th>Precio</th>
      <th>Stock</th>
      <th>img</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {{#each cart.products}}
      <tr>
        <td>{{this.product._id}}</td>
        <td>{{this.product.title}}</td>
        <td>{{this.product.code}}</td>
        <td>{{this.quantity}}</td>
        <td>${{this.product.price}}</td>
        <td>{{this.product.stock}}</td>
        <td> {{#if this.product.thumbnails}}
                <img src="{{this.product.thumbnails}}" alt="{{this.product.title}}"  title="{{this.product.title}}" class="imgChica">
            {{else}}
                <img src="../img/ImagenDefault.png" 
                    title="Proximamente se cargará una imagen del producto" 
                    alt="Proximamente se cargará una imagen del producto" 
                     class="imgChica">
                
            {{/if}}
        </td>
        <td>                
      {{!-- Botón: Borrar este producto del carrito  --}}

      <form id="deleteForm-{{this.product._id}}" style="display:inline;">
          <button type="button" 
          class="btn-treal" 
          onclick="eliminarProd('{{../cart._id}}','{{this.product._id}}','{{this.product.title}}')"
           title="Borrar este producto del carrito ">
    Eliminar 
  </button>
</form>
</td>
      </tr>
    {{/each}}
  </tbody>
</table>

<br>
<hr  class="lineaSupTit" >

<script>
  function eliminarProd(cartId, productId,title) {

    fetch(`/carts/${cartId}/product/${productId}`, {
      method: 'DELETE'
    })
    .then(res => {
      alert(`${title}: eliminado correctamente. altaProdCart`);
       if (!res.ok) throw new Error("Error eliminando producto");
         // Redirigimos la pagina
         window.location.href = `/carts/${cartId}`;
    })
    .catch(err => alert(err.message));
  }

 async function crearTicket(cartId) {

    try {
      // Leemos el email del usuario desde una variable en la vista (res.locals.user.email)
      // Para seguridad y simplicidad, inyecta el email en la vista desde 
      // server-side si está disponible.
      const purchaserEmail = {{#if user}}"{{user.email}}"{{else}}null{{/if}};

      // Si no hay email, pedimos al servidor que lo tome de la cookie/JWT (en backend).
      const body = purchaserEmail ? { purchaser: purchaserEmail } : {};


      const res = await fetch(`/api/carts/${cartId}/purchase`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await res.json();

      if (!res.ok) {
        alert(`Error apc.h: ${data.error || JSON.stringify(data)}`);
        return;
      }

      if (data.status === 'no_purchase') {
        alert('No se pudo comprar ningún producto: no hay stock suficiente.');
        // redirijo a la vista del carrito (mostrando los items restantes)
        window.location.href = `/carts/${cartId}`;
        return;
      }

      // Compra exitosa: data.ticket contiene el ticket generado
      alert(`Compra finalizada. Ticket: ${data.ticket.code}\nMonto: $${data.ticket.amount}`);

      // Opcional: puedes redirigir a un detalle del ticket o al carrito actualizado
      window.location.href = `/carts/${cartId}`;
    } catch (err) {
      alert(`Error creando ticket: ${err.message}`);
    }
  }
    
</script>
